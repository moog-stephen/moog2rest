<div id="padding-height">
    <H3>Listen Page</H3>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
        <li>
            <a href="#file" role="tab" data-toggle="tab">File</a>
        </li>
        <li>
            <a href="#socket" role="tab" data-toggle="tab">Socket</a>
        </li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
        <div class="tab-pane fade container-fluid" id="file">
            <h4>File Configuration</h4>

            <!-- Drop Zone -->
            <div class="dropzone col-sm-3 upload-drop-zone" id="drop-zone"></div>
            <div>
                <div class="dataTable_wrapper col-sm-6">
                    <table class="table" id="fileTable">
                        <tbody id="fileTable-body">
                        <!-- buildTable() output here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="tab-pane fade active in" id="socket">
            <h4>Socket Configuration</h4>
            <label class="form-inline label-inline">Listen to Interface</label>
            <div class="form-group" id="host-list">
                <!--Generated by script-->
            </div>

            <div class="form-group form-inline">
                <div class="form-group">
                    <label for="listenPage_port" class="form-inline label-inline">Port number</label>
                    <input type="number" class="form-control" id="listenPage_port" min="3000" max="90000"
                           placeholder="86411"/>
                </div>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label for="listenPage_cache" class="control-label">Capture lines</label>
        <select id="listenPage_cache" class="form-control">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
        </select>
    </div>
</div>
<div class="form-group full-height">
    <label class="control-label">Event Data</label>

    <div readonly class="form-control full-height" id="listenPage_listen_data_field"></div>
</div>

<script>

    // Set the page height correctly
    $('#pageContent').css("padding-bottom", function () {
        return ($('#padding-height').height() + 50) + 'px';
    });

    // Generate the form and populate with content from the server
    //
    var iFaces = chkPath(uiState, 'listenPage.iFaces');
    var $streamPort = $('#listenPage_port');
    var $streamCache = $('#listenPage_cache');
    var $listenDataField = $('#listenPage_listen_data_field');
    var $hostList = $('#host-list');
    var host = 'localhost';
    var port = 86411;
    var cache = 10;

    var $dropZone = document.getElementById('drop-zone');
    var $uploadForm = document.getElementById('js-upload-form');

    var startUpload = function (files) {
        console.log(files)
    };

    var i;

    window.addEventListener("dragover", function (e) {
        e = e || event;
        e.preventDefault();
    }, false);
    window.addEventListener("drop", function (e) {
        e = e || event;
        e.preventDefault();
    }, false);

    $hostList.html('<label class="radio-inline">' +
            '<input type="radio" name="ni" value="localhost">localhost</label>' +
            '<label class="radio-inline">' +
            '<input type="radio" name="ni" value="0.0.0.0">Any (0.0.0.0)</label>'
    );
    for (i = 0; i < iFaces.length; i += 1) {
        var rdb = '<label class="radio-inline">' +
                '<input type="radio" name="ni" value="' + iFaces[i] + '">' + iFaces[i] +
                '</label>';
        $hostList.append(rdb);
    }
    if (chkPath(uiState, 'listenPage.host')) {
        host = chkPath(uiState, 'listenPage.host');
    }
    fillObject(uiState, 'listenPage.host', host);
    $("input[name='ni'][value='" + host + "']").prop('checked', true);
    $("input[name='ni']")
            .change(function () {
                fillObject(uiState, 'listenPage.host', $(this).val());
                toSave('dirty');
            });

    if (chkPath(uiState, 'listenPage.port')) {
        port = chkPath(uiState, 'listenPage.port');
    }
    fillObject(uiState, 'listenPage.port', port);
    $streamPort.val(chkPath(uiState, 'listenPage.port'))
            .change(function () {
                fillObject(uiState, 'listenPage.port', $(this).val());
                toSave('dirty');
            });

    if (chkPath(uiState, 'listenPage.cache')) {
        cache = chkPath(uiState, 'listenPage.cache');
    }
    fillObject(uiState, 'listenPage.cache', cache);
    $streamCache.val(chkPath(uiState, 'listenPage.cache'))
            .change(function () {
                fillObject(uiState, 'listenPage.cache', $(this).val());
                toSave('dirty');
            });

    var dropZoneOptions = {
        url: "/upload",
        paramName: "eventfile", // The name that will be used to transfer the file
        maxFilesize: 10, // MB
        dictDefaultMessage: "Click to browse or drag a text file here to upload. Max file size 10Mb",
        clickable: true,
        createImageThumbnails: false,
        maxFiles: 1,
        addRemoveLinks: true,
        acceptedFiles: ".csv,.txt,.log,text/*",
        init: function () {
            this.on("success", function (serverResp) {
                if (fileList.indexOf(serverResp.name) < 0) {
                    fileList.push(serverResp.name);
                }

                $fileTable.html(buildTable(fileList));
                connectTableChange();

                //clear the dropzone
                myDropZone.removeFile(serverResp);

                if (fileList.length >= 4) {
                    myDropZone.element.innerText = 'The maximum of 4 files on the server has been reached.';
                    myDropZone.disable();
                } else {
                    myDropZone.element.innerText = "Click to browse or drag a text file here to upload. Max file size 10Mb";
                    myDropZone.enable();
                }
            });
        }
    };
    var myDropZone = new Dropzone($dropZone, dropZoneOptions);

    //TODO add a clear button and call this onClick
    //myDropZone.removeAllFiles(true);

    // catch the tab change event
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        var target = ($(e.target).attr("href")).replace('#', ''); // activated tab
        if (target !== chkPath(uiState, 'listenPage.streamType')) {
            fillObject(uiState, 'listenPage.streamType', target);
            toSave('dirty');
        }
    });

    var selectTab = chkPath(uiState, 'listenPage.streamType');
    var fileList = chkPath(uiState, 'listenPage.files');
    var odd = true;
    if (selectTab === 'file') {
        var $fileTable = $('#fileTable-body');
        // make file tab active
        $('.nav-tabs a[href="#' + selectTab + '"]').tab('show');
        $fileTable.html(buildTable(fileList));
        connectTableChange();
    }

    function buildTable(fileList) {
        var delButton = '<button type="button" class="btn btn-default btn-xs" name="DEL">' +
                '<span class="glyphicon glyphicon-remove" aria-hidden="true">' +
                '</span></button>';
        var playButton = '<button type="button" class="btn btn-default btn-xs" name="Play">' +
                '<span class="glyphicon glyphicon-play" aria-hidden="true">' +
                '</span></button>';
        var row = '';
        var table = '';
        for (i = 0; i < 4; i = i + 1) {

            if (odd) {
                odd = false;
                row += '<tr class="even">';
            }
            else {
                odd = true;
                row += '<tr class="odd">';
            }
            if (fileList[i]) {
                row += '<td class="file-name">' + fileList[i] + '</td>';
                row += '<td class="col-xs-3">' + playButton + delButton + '</td>';
            } else {
                row = '';
            }

            row += '</tr>';

            table += row;
            row = ''
        }
        return table;
    }

    function connectTableChange() {
        /*        $(".file-name")
         .css('cursor', 'pointer')
         .one("click", function () {
         var $element = $(this);
         var playFileName = $element.text();
         // Set this file as default for play
         socket.emit('playFile', playFileName);
         });
         */
        $(":button[name]")
                .on("click", function () {
                    var $element = $(this);
                    var action = this.name.toUpperCase();
                    var rowId = $element.closest('tr').index();
                    //alert(action + ' - ' + rowId);
                    if (action === "DEL") {
                        // delete the file on the server
                        socket.emit('delFile', fileList[rowId]);
                        fileList.splice(rowId, 1);

                        // Maybe do this when server confirms delete
                        $fileTable.html(buildTable(fileList));
                        connectTableChange();
                    }
                    if (action === 'PLAY') {
                        socket.emit('playFile', fileList[rowId]);
                        var $row = $element.parent().parent();
                        $row.siblings().removeClass("highlight-file");
                        $('.glyphicon-play', $row.siblings()).removeClass('text-success');
                        $row.addClass("highlight-file");
                        $('.glyphicon-play', $row).addClass('text-success');
                    }
                });
    }
</script>